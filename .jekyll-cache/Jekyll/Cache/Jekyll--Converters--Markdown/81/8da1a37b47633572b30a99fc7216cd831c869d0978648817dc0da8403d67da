I"59<p>前面大概介绍了QT的机制和控件的使用，现在开始写一个记事本，可以打开和保存文本文件。</p>

<hr />
<h2 id="头文件notepadh">头文件notepad.h</h2>
<p>头文件一般用来定义用户自己写或者继承的类，定义构造函数和其他实现功能逻辑的成员函数，还有一些私有成员变量。</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#ifndef NOTEPAD_H
#define NOTEPAD_H
#include &lt;QMainWindow&gt;
#include &lt;QTextEdit&gt;
#include &lt;QAction&gt;
#include &lt;QMenu&gt;
</span>
<span class="n">class</span> <span class="n">Notepad</span> <span class="o">:</span> <span class="n">public</span> <span class="n">QMainWindow</span>
<span class="p">{</span>
    <span class="n">Q_OBJECT</span>

<span class="nl">public:</span>
    <span class="n">Notepad</span><span class="p">();</span>

<span class="n">private</span> <span class="n">slots</span><span class="o">:</span>
    <span class="kt">void</span> <span class="n">open</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">save</span><span class="p">();</span>
    <span class="kt">void</span> <span class="n">quit</span><span class="p">();</span>

<span class="nl">private:</span>
    <span class="n">QTextEdit</span> <span class="o">*</span><span class="n">textEdit</span><span class="p">;</span>
    <span class="n">QAction</span> <span class="o">*</span><span class="n">openAction</span><span class="p">;</span>
    <span class="n">QAction</span> <span class="o">*</span><span class="n">saveAction</span><span class="p">;</span>
    <span class="n">QAction</span> <span class="o">*</span><span class="n">exitAction</span><span class="p">;</span>

    <span class="n">QMenu</span> <span class="o">*</span><span class="n">fileMenu</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif</span></code></pre></figure>

<p>其中open(),save(),quit()是用来接受信号后处理的槽函数，具体的实现在notepad.cpp中。</p>

<hr />
<h2 id="源文件notepadcpp">源文件notepad.cpp</h2>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#include "notepad.h"
#include "ui_notepad.h"
#include &lt;QFileDialog&gt;
#include &lt;QMessageBox&gt;
#include &lt;QString&gt;
#include &lt;QTextStream&gt;
#include &lt;QMenu&gt;
#include &lt;QMenuBar&gt;
</span>
<span class="n">Notepad</span><span class="o">::</span><span class="n">Notepad</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">openAction</span><span class="o">=</span><span class="n">new</span> <span class="n">QAction</span><span class="p">((</span><span class="s">"&amp;Open"</span><span class="p">),</span><span class="n">this</span><span class="p">);</span>
    <span class="n">saveAction</span><span class="o">=</span><span class="n">new</span> <span class="n">QAction</span><span class="p">(</span><span class="s">"&amp;Save"</span><span class="p">,</span><span class="n">this</span><span class="p">);</span>
    <span class="n">exitAction</span><span class="o">=</span><span class="n">new</span> <span class="n">QAction</span><span class="p">(</span><span class="s">"E&amp;xit"</span><span class="p">,</span><span class="n">this</span><span class="p">);</span>

    <span class="n">connect</span><span class="p">(</span><span class="n">openAction</span><span class="p">,</span><span class="n">SIGNAL</span><span class="p">(</span><span class="n">triggered</span><span class="p">()),</span><span class="n">this</span><span class="p">,</span><span class="n">SLOT</span><span class="p">(</span><span class="n">open</span><span class="p">()));</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">saveAction</span><span class="p">,</span><span class="n">SIGNAL</span><span class="p">(</span><span class="n">triggered</span><span class="p">()),</span><span class="n">this</span><span class="p">,</span><span class="n">SLOT</span><span class="p">(</span><span class="n">save</span><span class="p">()));</span>
    <span class="n">connect</span><span class="p">(</span><span class="n">exitAction</span><span class="p">,</span><span class="n">SIGNAL</span><span class="p">(</span><span class="n">triggered</span><span class="p">()),</span><span class="n">this</span><span class="p">,</span><span class="n">SLOT</span><span class="p">(</span><span class="n">quit</span><span class="p">()));</span>

    <span class="c1">//fileMenu=menuBar()-&gt;addMenu("File");//Copy</span>
    <span class="n">fileMenu</span><span class="o">=</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">menuBar</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">addMenu</span><span class="p">(</span><span class="s">"File"</span><span class="p">);</span>
    <span class="n">fileMenu</span><span class="o">-&gt;</span><span class="n">addAction</span><span class="p">(</span><span class="n">openAction</span><span class="p">);</span>
    <span class="n">fileMenu</span><span class="o">-&gt;</span><span class="n">addAction</span><span class="p">(</span><span class="n">saveAction</span><span class="p">);</span>
    <span class="n">fileMenu</span><span class="o">-&gt;</span><span class="n">addSeparator</span><span class="p">();</span>
    <span class="n">fileMenu</span><span class="o">-&gt;</span><span class="n">addAction</span><span class="p">(</span><span class="n">exitAction</span><span class="p">);</span>

    <span class="n">textEdit</span><span class="o">=</span><span class="n">new</span> <span class="n">QTextEdit</span><span class="p">;</span>
    <span class="n">setCentralWidget</span><span class="p">(</span><span class="n">textEdit</span><span class="p">);</span>

    <span class="n">setWindowTitle</span><span class="p">(</span><span class="s">"Notepad"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Notepad</span><span class="o">::</span><span class="n">open</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">QString</span> <span class="n">fileName</span><span class="o">=</span><span class="n">QFileDialog</span><span class="o">::</span><span class="n">getOpenFileName</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="s">"Open File"</span><span class="p">,</span><span class="s">""</span><span class="p">,</span> \
    <span class="s">"Text Files(*txt);;c++ Files(*.cpp *.h)"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fileName</span><span class="o">!=</span><span class="s">""</span><span class="p">){</span>
        <span class="n">QFile</span> <span class="n">file</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">QIODevice</span><span class="o">::</span><span class="n">ReadOnly</span><span class="p">)){</span>
            <span class="n">QMessageBox</span><span class="o">::</span><span class="n">critical</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="s">"Error"</span><span class="p">,</span><span class="s">"could not open file"</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">QTextStream</span> <span class="k">in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
        <span class="n">textEdit</span><span class="o">-&gt;</span><span class="n">setText</span><span class="p">(</span><span class="k">in</span><span class="p">.</span><span class="n">readAll</span><span class="p">());</span>
        <span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Notepad</span><span class="o">::</span><span class="n">save</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">QString</span> <span class="n">fileName</span><span class="o">=</span><span class="n">QFileDialog</span><span class="o">::</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="n">this</span><span class="p">,</span><span class="s">"Save File"</span><span class="p">,</span><span class="s">""</span><span class="p">,</span> \
    <span class="s">"Text Files(*.txt);;C++ Files(*.cpp *.h)"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fileName</span><span class="o">!=</span><span class="s">""</span><span class="p">){</span>
        <span class="n">QFile</span> <span class="n">file</span><span class="p">(</span><span class="n">fileName</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">QIODevice</span><span class="o">::</span><span class="n">WriteOnly</span><span class="p">)){</span>
            <span class="c1">//error</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">QTextStream</span> <span class="n">stream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">file</span><span class="p">);</span>
            <span class="n">stream</span><span class="o">&lt;&lt;</span><span class="n">textEdit</span><span class="o">-&gt;</span><span class="n">toPlainText</span><span class="p">();</span>
            <span class="n">stream</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
            <span class="n">file</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">Notepad</span><span class="o">::</span><span class="n">quit</span><span class="p">()</span>
 <span class="p">{</span>
 <span class="n">QMessageBox</span> <span class="n">messageBox</span><span class="p">;</span>
  <span class="n">messageBox</span><span class="p">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"Notepad"</span><span class="p">));</span>
 <span class="n">messageBox</span><span class="p">.</span><span class="n">setText</span><span class="p">(</span><span class="n">tr</span><span class="p">(</span><span class="s">"Do you really want to quit?"</span><span class="p">));</span>
 <span class="n">messageBox</span><span class="p">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">::</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">::</span><span class="n">No</span><span class="p">);</span>
 <span class="n">messageBox</span><span class="p">.</span><span class="n">setDefaultButton</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">::</span><span class="n">No</span><span class="p">);</span>
 <span class="k">if</span> <span class="p">(</span><span class="n">messageBox</span><span class="p">.</span><span class="n">exec</span><span class="p">()</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">::</span><span class="n">Yes</span><span class="p">)</span>
      <span class="n">qApp</span><span class="o">-&gt;</span><span class="n">quit</span><span class="p">();</span>
 <span class="p">}</span></code></pre></figure>

<p>notepad.cpp中主要实现在notepad.h中定义的成员函数。Notepad()是构造函数，建立一个对象时会自动调用。open()函数打开文本文件，save()保存文本文件，quit()退出界面。</p>

<p>QAction是QObject的一个子类,构造函数是<code class="language-plaintext highlighter-rouge">QAction(const QString &amp;text, QObject* parent)</code>,用来建立Menu下的三个下拉菜单。</p>

<p><code class="language-plaintext highlighter-rouge">fileMenu=menuBar()-&gt;addMenu("File")</code>这一句话比较难理解，可以换作<code class="language-plaintext highlighter-rouge">fileMenu=this-&gt;menuBar()-&gt;addMenu("File")</code>看。menuBar()在qmianwindow.h中定义为<code class="language-plaintext highlighter-rouge">QMenuBar *menuBar() const</code>。</p>

<p>menuBar()是一个指向QMenuBar的指针，就是调用Notepad继承自QMainWindow的成员函数，将File目录添加到menuBar中赋值给fileMenu对象。</p>

<p>getOpenFileName和critical都是静态方法。用来获取打开的文件名和输出错误提示。多注意一下静态方法和静态变量的使用，参见<strong>C++ Primer</strong> Page 268~272。</p>

<hr />

<h2 id="main函数">Main函数</h2>
<p>修改Main函数如下：</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc"><span class="cp">#include "notepad.h"
#include &lt;QApplication&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">QApplication</span> <span class="n">a</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
    <span class="n">Notepad</span> <span class="o">*</span><span class="n">pad</span><span class="o">=</span><span class="n">new</span> <span class="n">Notepad</span><span class="p">;</span>
    <span class="n">pad</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">a</span><span class="p">.</span><span class="n">exec</span><span class="p">();</span>
<span class="p">}</span></code></pre></figure>

<p>运行结果如图
<img src="/assets/images/QT2-1.png" alt="图片" /></p>

<hr />
<h2 id="reference">Reference</h2>
<p>[1].http://qt-project.org/doc/qt-4.8/gettingstartedqt.html</p>

<p>[2].http://see.xidian.edu.cn/cpp/biancheng/view/210.html</p>

<p>[3].C++ Primer. Page268~272</p>
:ET