I"ãu<p>ç°åœ¨å·²ç»æ˜¯3Gã€4Gçš„å¤©ä¸‹ï¼Œä½†å¤è€çš„GSMæ¨¡å¼ä¸­æœ‰ä¸€ä¸ªGPRSæ•°æ®æ‰¿è½½æœåŠ¡ï¼Œæ˜¯åœ¨2Gç½‘ç»œä¸‹å¯¹ä¸Šç½‘éœ€æ±‚çš„ä¼˜åŒ–ã€‚</p>

<hr />
<h2 id="gsmå’Œgprs">GSMå’ŒGPRS</h2>
<p>GSMæ˜¯å…¨çƒç§»åŠ¨é€šè®¯ç³»ç»ŸGlobal System of Mobile communicationï¼Œåˆ†å±äº2Gé€šä¿¡ã€‚</p>

<p>GPRSæ˜¯Gerneral Packer Radio Serviceçš„è‹±æ–‡ç¼©å†™ï¼Œä¸­æ–‡è¯‘ä¸ºé€šç”¨æ— çº¿åˆ†ç»„ä¸šåŠ¡ï¼Œå…·ä½“æ¥è®²ï¼ŒGPRSæ˜¯ä¸€é¡¹é«˜é€Ÿæ•°æ®å¤„ç†çš„ç§‘æŠ€ï¼Œå³ä»¥åˆ†ç»„çš„â€œå½¢å¼â€æŠŠæ•°æ®ä¼ é€åˆ°ç”¨æˆ·æ‰‹ä¸Šã€‚</p>

<p>GPRSæ˜¯åœ¨GSMç³»ç»Ÿä¸Šå‘å±•å‡ºæ¥çš„ä¸€ç§æ–°çš„æ‰¿è½½ä¸šåŠ¡ï¼Œç›®çš„æ˜¯ä¸ºGSMç”¨æˆ·æä¾›åˆ†ç»„å½¢å¼çš„æ•°æ®ä¸šåŠ¡ã€‚GPRSé‡‡ç”¨ä¸GSMåŒæ ·çš„æ— çº¿è°ƒåˆ¶æ ‡å‡†ã€é¢‘å¸¦ã€çªå‘ç»“æ„ã€è·³é¢‘è§„åˆ™ä»¥åŠåŒæ ·çš„TDMAå¸§ç»“æ„ã€‚</p>

<p>GPRSå…è®¸ç”¨æˆ·åœ¨ç«¯åˆ°ç«¯åˆ†ç»„æ¨¡å¼ä¸‹å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œä¸éœ€è¦åˆ©ç”¨<strong>ç”µè·¯äº¤æ¢æ¨¡å¼</strong>çš„ç½‘ç»œèµ„æºï¼Œä»è€Œæä¾›äº†ä¸€ç§é«˜æ•ˆã€ä½æˆæœ¬çš„æ— çº¿åˆ†ç»„æ•°æ®ä¸šåŠ¡ã€‚</p>

<hr />
<h2 id="atæŒ‡ä»¤æ§åˆ¶">ATæŒ‡ä»¤æ§åˆ¶</h2>
<p>éƒ¨åˆ†GPRSæ¨¡å—å†…ç½®äº†TCP/IPåè®®æ ˆï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„é€šè¿‡å‚å®¶æ‰©å±•çš„ATæŒ‡ä»¤ç›´æ¥è¿›è¡ŒTCPæˆ–UDPé€šä¿¡ã€‚</p>

<p>è¿™æ˜¯åœ¨RTOSï¼ˆRT-Thread Operating System)é‡Œé¢çš„ä¸€æ®µæ§åˆ¶Zigbeeæ¨¡å—ç”¨GPRSé€šä¿¡æ–¹å¼å’ŒæœåŠ¡å™¨é€šä¿¡çš„ä»£ç ï¼š</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">    <span class="kt">void</span> <span class="nf">thread_gsm_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameter</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">gsm_init_hw</span><span class="p">(</span><span class="s">"uart3"</span><span class="p">);</span>

    <span class="n">rt_kprintf</span><span class="p">(</span><span class="s">"gsm init hardware success </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">thread_gsm_at</span> <span class="o">=</span> <span class="n">rt_thread_create</span><span class="p">(</span><span class="s">"gsm_at"</span><span class="p">,</span>
                                     <span class="n">thread_gsm_at_entry</span><span class="p">,</span> <span class="n">RT_NULL</span><span class="p">,</span>
                                     <span class="mi">1024</span><span class="p">,</span>
                                     <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">thread_gsm_at</span> <span class="o">!=</span> <span class="n">RT_NULL</span><span class="p">)</span>
    <span class="p">{</span> <span class="n">rt_thread_startup</span><span class="p">(</span><span class="n">thread_gsm_at</span><span class="p">);</span> <span class="p">}</span>

    <span class="n">gsm_power_switch</span><span class="p">();</span>
    <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span> <span class="c1">//æµ‹è¯•è¿æ¥æ˜¯å¦æ­£ç¡®</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"ATE1</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"ATE1</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span> <span class="c1">//æ‰“å¼€å›æ˜¾</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CSQ</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CSQ</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span> <span class="c1">//æ£€æŸ¥ä¿¡å·</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CGREG?</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CGREG?</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span><span class="c1">//è·å–å°åŒºç¯å¢ƒ</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CGATT?</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CGATT?</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span> <span class="c1">//æ¿€æ´»</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CSTT</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CSTT</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CIICR</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CIICR</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CIFSR</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CIFSR</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
        <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="s">"AT+CIPSTART=</span><span class="se">\"</span><span class="s">TCP</span><span class="se">\"</span><span class="s">,</span><span class="se">\"</span><span class="s">202.201.1.49</span><span class="se">\"</span><span class="s">,12345</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
                    <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CIPSTART=</span><span class="se">\"</span><span class="s">TCP</span><span class="se">\"</span><span class="s">,</span><span class="se">\"</span><span class="s">202.201.1.49</span><span class="se">\"</span><span class="s">,12345</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>

    <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CIPSEND=6</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CIPSEND=6</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>

    <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"DEMO</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"DEMO</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>
    <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>

    <span class="n">gsm_inited</span> <span class="o">=</span> <span class="n">RT_TRUE</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<hr />
<h2 id="atæŒ‡ä»¤æ­¥éª¤å’Œä½œç”¨">ATæŒ‡ä»¤æ­¥éª¤å’Œä½œç”¨</h2>

<p>ATæŒ‡ä»¤çš„æ­¥éª¤å’Œä½œç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<ul>
  <li>AT æµ‹è¯•è¿æ¥æ˜¯å¦æ­£ç¡®</li>
  <li>TE1 æ‰“å¼€å›æ˜¾</li>
  <li>AT+CSQ  è¿”å›å€¼æ˜¯ä¿¡å·è´¨é‡ï¼Œè¶Šå¤§è¶Šè´¨é‡è¶Šå¥½ã€‚</li>
  <li>AT+CGREG å¯ä»¥æŸ¥è¯¢GPRSçŠ¶æ€ ä¸€èˆ¬æ³¨å†Œä¸Šè¿è¥å•†ï¼Œé™„ç€GPRSéƒ½æ˜¯è‡ªåŠ¨è¿›è¡Œ æŸ¥è¯¢æ¨¡å—æ˜¯å¦æœ‰æ³¨å†Œç½‘ç»œ</li>
  <li>AT+CGATT å¼€æœºåï¼Œå¦‚æœâ€œAT+CGATTï¼Ÿâ€å‘½ä»¤çš„è¿”å›å€¼ä¸º1ï¼Œè¯´æ˜SIMå¡å·²ç»å¼€é€šäº†GRPSæœåŠ¡</li>
  <li>AT+CSTT è®¾ç½®APN</li>
  <li>AT+CIICR æ¿€æ´»ç§»åŠ¨åœºæ™¯</li>
  <li>AT+CIFSR è·å¾—æœ¬åœ°IPåœ°å€</li>
  <li>AT+CIPSTART="TCP","202.201.xx.xx",12345\r\n  å»ºç«‹TCPè¿æ¥</li>
  <li>AT+CIPSEND=6 å¼€å§‹å‘é€æ•°æ®ï¼Œæ•°æ®é•¿åº¦ä¸º6</li>
  <li>å‘é€æµ‹è¯•æ•°æ®â€œDEMO\r\nâ€</li>
</ul>

<hr />
<h2 id="æœåŠ¡å™¨ç«¯">æœåŠ¡å™¨ç«¯</h2>

<p>æœåŠ¡å™¨é‡‡ç”¨CentOSæ“ä½œç³»ç»Ÿï¼Œå®‰è£…JVMã€‚å› ä¸ºGPRSæ¥çš„æ•°æ®æ˜¯TCPæŠ¥æ–‡æ ¼å¼ï¼Œå¯ä»¥é‡‡ç”¨Socketç¼–ç¨‹è¿›è¡Œæ¥æ”¶ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®å¯ä»¥æ’å…¥åˆ°æ•°æ®åº“ä¸­è¿›è¡Œä¿å­˜ã€‚è¿™æ ·å°±å¯ä»¥ä¿å­˜å’Œæ£€ç´¢ä¼ æ„Ÿå™¨èŠ‚ç‚¹çš„é‡‡æ ·æ•°æ®ã€‚</p>

<p>Serverç«¯ä»£ç é‡‡ç”¨Javaç¼–å†™ï¼Œå¾ˆå®¹æ˜“ã€‚</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">     <span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">net</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>
    <span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">io</span><span class="p">.</span><span class="o">*</span><span class="p">;</span>
    <span class="n">public</span> <span class="n">class</span> <span class="n">Server</span>
    <span class="p">{</span>
    <span class="n">private</span> <span class="n">ServerSocket</span> <span class="n">ss</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">Socket</span> <span class="n">socket</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">BufferedReader</span> <span class="k">in</span><span class="p">;</span>
    <span class="n">private</span> <span class="n">PrintWriter</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">public</span> <span class="n">Server</span><span class="p">()</span>
    <span class="p">{</span>
    <span class="n">try</span>
    <span class="p">{</span>
    <span class="n">ss</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ServerSocket</span><span class="p">(</span><span class="mi">12345</span><span class="p">);</span>
    <span class="n">socket</span> <span class="o">=</span> <span class="n">ss</span><span class="p">.</span><span class="n">accept</span><span class="p">();</span>
    <span class="k">in</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BufferedReader</span><span class="p">(</span><span class="n">new</span> <span class="n">InputStreamReader</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">getInputStream</span><span class="p">()));</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">new</span> <span class="n">PrintWriter</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">getOutputStream</span><span class="p">(),</span><span class="nb">true</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="k">in</span><span class="p">.</span><span class="n">readLine</span><span class="p">();</span>
    <span class="n">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Monitoring data :"</span> <span class="o">+</span> <span class="n">line</span><span class="p">);</span>
    <span class="c1">//out.close();</span>
    <span class="c1">// in.close();</span>
    <span class="c1">//socket.close();</span>
    <span class="p">}</span>
    <span class="n">ss</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{}</span>
    <span class="p">}</span>
    <span class="n">public</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">new</span> <span class="n">Server</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="p">}</span></code></pre></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯åƒä¸‡ä¸è¦ä½¿ç”¨out.printlnï¼Œå¯èƒ½ä¼šé˜»å¡é€šä¿¡ã€‚</p>

<p>socket = ss.accept()è¦æ”¾åœ¨whileå¾ªç¯å¤–é¢æŒç»­æ¥æ”¶æ•°æ®ã€‚</p>

<p>ä¹Ÿä¸è¦å…³é—­socketå’Œinè¾“å…¥æµã€‚Zigbeeä¼ æ¥çš„æ•°æ®æ˜¯ä¸€ä¸ªæ¯éš”3Sçš„æ•°æ®æµã€‚</p>

<p><img src="http://static.oschina.net/uploads/space/2014/0416/111049_ABdF_1420197.jpg" alt="åœ¨æ­¤è¾“å…¥å›¾ç‰‡æè¿°" /></p>

<hr />
<h2 id="rtosç®€ä»‹1">RTOSç®€ä»‹[1]</h2>

<p>RT-Threayd RTOSæ˜¯ä¸€æ¬¾æ¥è‡ªä¸­å›½çš„å¼€æºå®æ—¶æ“ä½œç³»ç»Ÿï¼Œç”±å›½å†…ä¸€äº›ä¸“ä¸šå¼€å‘äººå‘˜å¼€å‘ã€ç»´æŠ¤ã€‚å®ƒä¸ä»…ä»…æ˜¯ä¸€æ¬¾é«˜æ•ˆã€ç¨³å®šçš„å®æ—¶æ ¸å¿ƒï¼Œä¹Ÿæ˜¯ä¸€å¥—é¢å‘åµŒå…¥å¼ç³»ç»Ÿçš„è½¯ä»¶å¹³å°ï¼Œè¦†ç›–äº†å…¨æŠ¢å çš„å®æ—¶æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œå°å·§è€Œä¸åº•å±‚å…·ä½“å®ç°æ— å…³çš„æ–‡ä»¶ç³»ç»Ÿï¼Œè½»å‹çš„TCP/IPåè®®æ ˆä»¥åŠè½»å‹çš„å¤šçª—å£å¤šçº¿ç¨‹å›¾å½¢ç”¨æˆ·ç•Œé¢ã€‚</p>

<hr />
<h2 id="rtosåº”ç”¨">RTOSåº”ç”¨</h2>
<p>è¿™ä¸ªä¾‹å­é‡Œé¢æœ‰ä¸‰ä¸ªä»»åŠ¡ï¼ˆè¿›ç¨‹ï¼‰ï¼šä¸€ä¸ªæ˜¯DEMOè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯RFè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯GSMè¿›ç¨‹ã€‚æˆ‘ä»¬çœ‹çœ‹ä»»åŠ¡çš„å†™æ³•ï¼š</p>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">    <span class="c1">//è®¾ç½®å’ŒDEMOè¿›ç¨‹ç›¸å…³çš„å †æ ˆã€æ•°æ®ç»“æ„å’Œå£°æ˜ç›¸å…³çš„å‡½æ•°</span>
    <span class="n">ALIGN</span><span class="p">(</span><span class="n">RT_ALIGN_SIZE</span><span class="p">)</span>  <span class="c1">//DEMOçº¿ç¨‹ï¼Œç‚¹ç¯çº¿ç¨‹</span>
    <span class="k">static</span> <span class="n">rt_uint8_t</span> <span class="n">demo_stack</span><span class="p">[</span> <span class="mi">2048</span> <span class="p">];</span>
    <span class="k">static</span> <span class="k">struct</span> <span class="n">rt_thread</span> <span class="n">thread_demo</span><span class="p">;</span> 
    <span class="k">extern</span> <span class="kt">void</span> <span class="nf">thread_demo_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameter</span><span class="p">);</span>

    <span class="n">ALIGN</span><span class="p">(</span><span class="n">RT_ALIGN_SIZE</span><span class="p">)</span>  <span class="c1">//RFçº¿ç¨‹ï¼Œæ¥æ”¶Zigbeeåˆ†èŠ‚ç‚¹çš„æ•°æ®ï¼Œé€šè¿‡GPRSä¸Server Socketé€šä¿¡</span>
    <span class="k">static</span> <span class="n">rt_uint8_t</span> <span class="n">rf_stack</span><span class="p">[</span> <span class="mi">2048</span> <span class="p">];</span>
    <span class="k">static</span> <span class="k">struct</span> <span class="n">rt_thread</span> <span class="n">thread_rf</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">thread_rf_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameter</span><span class="p">);</span>

    <span class="n">ALIGN</span><span class="p">(</span><span class="n">RT_ALIGN_SIZE</span><span class="p">)</span>  <span class="c1">//GSMçº¿ç¨‹ï¼Œåˆå§‹åŒ–GSMè®¾ç½®ï¼Œåˆæ¬¡é€šä¿¡ï¼Œå‘é€â€œDEMOâ€å­—ç¬¦ã€‚</span>
    <span class="k">static</span> <span class="n">rt_uint8_t</span> <span class="n">gsm_stack</span><span class="p">[</span> <span class="mi">2048</span> <span class="p">];</span>
    <span class="k">static</span> <span class="k">struct</span> <span class="n">rt_thread</span> <span class="n">thread_gsm</span><span class="p">;</span> 
    <span class="kt">void</span> <span class="nf">thread_gsm_entry</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">parameter</span><span class="p">);</span>

    <span class="kt">int</span> <span class="nf">rt_application_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="n">rt_err_t</span> <span class="n">result</span><span class="p">;</span>

    <span class="cm">/* init demo thread */</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">rt_thread_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_demo</span><span class="p">,</span>
                            <span class="s">"demo"</span><span class="p">,</span>
                            <span class="n">thread_demo_entry</span><span class="p">,</span>
                            <span class="n">RT_NULL</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">rt_uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">demo_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="k">sizeof</span><span class="p">(</span><span class="n">demo_stack</span><span class="p">),</span>
                            <span class="mi">30</span><span class="p">,</span>
                            <span class="mi">5</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">RT_EOK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_thread_startup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_demo</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* init rf thread */</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">rt_thread_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_rf</span><span class="p">,</span>
                            <span class="s">"rf"</span><span class="p">,</span>
                            <span class="n">thread_rf_entry</span><span class="p">,</span>
                            <span class="n">RT_NULL</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">rt_uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rf_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="k">sizeof</span><span class="p">(</span><span class="n">rf_stack</span><span class="p">),</span>
                            <span class="mi">10</span><span class="p">,</span>
                            <span class="mi">5</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">RT_EOK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_thread_startup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_rf</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="cm">/* init gsm thread */</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">rt_thread_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_gsm</span><span class="p">,</span>
                            <span class="s">"gsm"</span><span class="p">,</span>
                            <span class="n">thread_gsm_entry</span><span class="p">,</span>
                            <span class="n">RT_NULL</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">rt_uint8_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">gsm_stack</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                            <span class="k">sizeof</span><span class="p">(</span><span class="n">gsm_stack</span><span class="p">),</span>
                            <span class="mi">20</span><span class="p">,</span>
                            <span class="mi">5</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">RT_EOK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">rt_thread_startup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thread_gsm</span><span class="p">);</span>
    <span class="p">}</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></code></pre></figure>

<hr />
<h2 id="æ ¸å¿ƒæ”¶æ®æ”¶å‘">æ ¸å¿ƒæ”¶æ®æ”¶å‘</h2>

<figure class="highlight"><pre><code class="language-objc" data-lang="objc">    <span class="k">if</span> <span class="p">(</span><span class="n">gsm_inited</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"AT+CIPSEND="</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"AT+CIPSEND="</span><span class="p">));</span>
                <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_temp</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">num_temp</span><span class="p">));</span>
                <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">));</span>

                <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">1</span><span class="p">);</span>

                <span class="n">rt_device_write</span><span class="p">(</span><span class="n">gsm_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_temp</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">data_temp</span><span class="p">));</span>

                <span class="n">rt_thread_delay</span><span class="p">(</span><span class="n">RT_TICK_PER_SECOND</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
            <span class="p">}</span></code></pre></figure>

<p>å…¶ä¸­gsm_initedåœ¨GSMçº¿ç¨‹ä¸­è¢«ç½®ä½ï¼ˆgsm_inited = RT_TRUE)ï¼Œè¡¨æ˜æ¨¡å—è°ƒè¯•å’Œåˆå§‹åŒ–å®Œæ¯•ï¼Œå¼€å§‹æ”¶å‘æ•°æ®ã€‚</p>

<p>è¿™æ˜¯åœ¨RFçº¿ç¨‹ï¼ˆä»»åŠ¡ï¼‰ä¸­å†™çš„æ•°æ®æ ¸å¿ƒæ”¶å‘ç¨‹åºï¼Œdata_tempä¸­å­˜å‚¨çš„æ˜¯èŠ‚ç‚¹å‘æ¥çš„æ•°æ®ï¼Œ rt_device_write(gsm_dev, 0, data_temp, strlen(data_temp))ä½¿å¾—æ•°æ®ä¼ åˆ°æœåŠ¡å™¨ä¸Šã€‚</p>

<hr />
<h2 id="reference">Reference</h2>

<p>[1].http://www.rt-thread.org/</p>

<p>[2].http://www.linuxidc.com/Linux/2012-09/69974.htm</p>

:ET