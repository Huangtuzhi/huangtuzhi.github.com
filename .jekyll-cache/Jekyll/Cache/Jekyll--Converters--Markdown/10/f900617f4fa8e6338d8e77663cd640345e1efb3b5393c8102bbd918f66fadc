I"“ <p>å‰é¢åˆ†æäº†<code class="language-plaintext highlighter-rouge">ngx_array_t</code>æ•°ç»„ï¼Œç°åœ¨çœ‹ä¸€ä¸‹<code class="language-plaintext highlighter-rouge">ngx_queue</code>é˜Ÿåˆ—å’Œ<code class="language-plaintext highlighter-rouge">ngx_hash</code>å“ˆå¸Œè¡¨çš„å®ç°ã€‚</p>

<hr />
<h2 id="ngx_queueé˜Ÿåˆ—">ngx_queueé˜Ÿåˆ—</h2>

<p><code class="language-plaintext highlighter-rouge">ngx_queue_t</code>æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå®ç°äº†ä¸€ä¸ªé˜Ÿåˆ—çš„æ“ä½œé€»è¾‘ã€‚ä½†æ˜¯å®ƒçš„ç»“æ„åªè¡ŒæŒ‡é’ˆçš„æ“ä½œï¼Œå› è€Œåœ¨å®šä¹‰è‡ªå·±çš„èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦è‡ªå·±å®šä¹‰æ•°æ®ç»“æ„å’Œåˆ†é…ç©ºé—´ï¼Œå¹¶<strong>åŒ…å«</strong>ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">ngx_queue_t</code>ç±»å‹çš„æˆå‘˜ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct ngx_queue_s ngx_queue_t;

struct ngx_queue_s {
    ngx_queue_t  *prev;
    ngx_queue_t  *next;
};
</code></pre></div></div>

<p>è¿™å’ŒLinuxå†…æ ¸çš„æ•°æ®ç»“æ„å¾ˆåƒã€‚å®ƒä»¬éƒ½<strong>å°†é“¾è¡¨èŠ‚ç‚¹å¡å…¥æ•°æ®ç»“æ„</strong>ã€‚Linuxå†…æ ¸çš„é“¾è¡¨è¿™æ ·å®šä¹‰ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct list_head
{
    struct list_head *next;
    struct list_head *prev;
}
</code></pre></div></div>

<p>ä½¿ç”¨çš„æ—¶å€™</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>struct fox
{
    unsigned long tail_length;
    unsigned long weight;
    bool  is_fantastic;
    struct list_head list;
}
</code></pre></div></div>
<p>ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>

<p><img src="/assets/images/nginx-3-1.png" alt="å›¾ç‰‡" /></p>

<p>æ‰€ä»¥å®ƒç”¨<code class="language-plaintext highlighter-rouge">fox.list.next</code>æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç”¨<code class="language-plaintext highlighter-rouge">fox.list.prev</code>æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ã€‚é‚£æˆ‘ä»¬å¦‚ä½•ä»<code class="language-plaintext highlighter-rouge">list_head</code>æ‰¾åˆ°<code class="language-plaintext highlighter-rouge">fox</code>çš„åœ°å€å‘¢ã€‚å†…æ ¸æä¾›äº†ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">container_of()</code>å®å¯ä»¥ä»é“¾è¡¨æŒ‡é’ˆæ‰¾åˆ°çˆ¶ç»“æ„ä¸­åŒ…å«çš„ä»»ä½•å˜é‡ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define container_of(ptr, type, member) ({ \ 
    const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);\ 
(type *)( (char *)__mptr - offsetof(type,member) );)
</code></pre></div></div>

<p>è€Œåœ¨Nginxä¹Ÿæ˜¯æ•ˆä»¿é‡‡ç”¨ä¸€æ ·çš„å®è·å–çˆ¶ç»“æ„åœ°å€ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define ngx_queue_data(q, type, link)   \
    (type *) ((u_char *) q - offsetof(type, link))
</code></pre></div></div>
<hr />

<p>##ç”¨æ³•</p>

<p>å®ƒçš„APIå®šä¹‰äº†åˆå§‹åŒ–ï¼Œæ’å…¥ï¼Œæ’åºï¼Œæ‰¾ä¸­ä½èŠ‚ç‚¹ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚</p>

<p>ç”¨æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct yahoo_s {
    ngx_queue_t   queue;
} yahoo_t;

typedef struct yahoo_guy_s {
    ngx_uint_t    id;
    u_char*       name;
    ngx_queue_t   queue;
} yahoo_guy_t;

ngx_int_t yahoo_no_cmp(const ngx_queue_t* p, const ngx_queue_t* n)
{
    yahoo_guy_t *pre, *next;
    pre  = (yahoo_guy_t*) ngx_queue_data(p, yahoo_guy_t, queue);
    next = (yahoo_guy_t*) ngx_queue_data(n, yahoo_guy_t, queue);
    return ((pre-&gt;id &gt; next-&gt;id) ? 1:0);
}

int main()
{
    ngx_pool_t*     pool;
    yahoo_guy_t*    guy;
    ngx_queue_t*    q;
    yahoo_t*        yahoo;
    pool= ngx_create_pool(1024*10, NULL); //åˆå§‹åŒ–å†…å­˜æ± 
    int i;
    // æ„å»ºé˜Ÿåˆ—
    const ngx_str_tnames[] = {
ngx_string("rainx"), ngx_string("xiaozhe"), ngx_string("zhoujian")} ;
    const in ids[] = {4611, 8322, 6111};

    yahoo = ngx_palloc(pool, sizeof(yahoo_t));
    ngx_queue_init(&amp;yahoo-&gt;queue); //åˆå§‹åŒ–queue

    for(i = 0; i &lt; 3; i++)
    {
      guy = (yahoo_guy_t*) ngx_palloc(pool, sizeof(yahoo_guy_t));
      guy-&gt;id   = ids[i];
      guy-&gt;name = (u_char*) ngx_pstrdup(pool, (ngx_str_t*) &amp;(names[i]) );
      ngx_queue_init(&amp;guy-&gt;queue);
      // ä»å¤´éƒ¨è¿›å…¥é˜Ÿåˆ—
      ngx_queue_insert_head(&amp;yahoo-&gt;queue, &amp;guy-&gt;queue);
    }

    // ä»å°¾éƒ¨éå†è¾“å‡º
    for(q = ngx_queue_last(&amp;yahoo-&gt;queue);
        q != ngx_queue_sentinel(&amp;yahoo-&gt;queue);
        q = ngx_queue_prev(q) ) {
        guy = ngx_queue_data(q, yahoo_guy_t, queue);
        printf("No. %d guy in yahoo is %s \n", guy-&gt;id, guy-&gt;name);
    }

    // æ’åºä»å¤´éƒ¨è¾“å‡º
    ngx_queue_sort(&amp;yahoo-&gt;queue, yahoo_no_cmp);
    printf("sorting....\n");
    for(q = ngx_queue_prev(&amp;yahoo-&gt;queue);
        q != ngx_queue_sentinel(&amp;yahoo-&gt;queue);
        q = ngx_queue_last(q) ) {
        guy = ngx_queue_data(q, yahoo_guy_t, queue);
        printf("No. %d guy in yahoo is %s \n", guy-&gt;id, guy-&gt;name);
    }

    ngx_destroy_pool(pool);
    return 0;
}
</code></pre></div></div>

<hr />

<h2 id="ngx_hashå“ˆå¸Œè¡¨">ngx_hashå“ˆå¸Œè¡¨</h2>

<p><code class="language-plaintext highlighter-rouge">ngx_hash</code>è¡¨æ‰€ç”¨çš„hashç®—æ³•ä¸º<strong>åˆ†æ¡¶åçº¿æ€§æŸ¥æ‰¾æ³•</strong>ï¼Œå› è€ŒæŸ¥æ‰¾æ•ˆç‡åŒkey-valueå¯¹æˆåæ¯”ã€‚å¯¹äºå¸¸ç”¨çš„è§£å†³å†²çªçš„æ–¹æ³•æœ‰çº¿æ€§æ¢æµ‹ã€äºŒæ¬¡æ¢æµ‹å’Œå¼€é“¾æ³•ç­‰ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯æœ€å¸¸ç”¨çš„å¼€é“¾æ³•(ä¹Ÿæ˜¯STLä¸­ä½¿ç”¨çš„æ–¹æ³•)ã€‚</p>

<p>å“ˆå¸Œè¡¨æ•´ä¸ªç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>

<p><img src="/assets/images/nginx-3-2.png" alt="å›¾ç‰‡" /></p>

<p>å“ˆå¸Œè¡¨ç”¨ä¸‹åˆ—æ•°æ®ç»“æ„è¿›è¡Œç®¡ç†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    ngx_hash_t       *hash;
    ngx_hash_key_pt   key;

    ngx_uint_t        max_size;
    ngx_uint_t        bucket_size;
    char             *name;
    ngx_pool_t       *pool;
    ngx_pool_t       *temp_pool;
} ngx_hash_init_t;
</code></pre></div></div>

<p>åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå…ˆä¼šç”¨<code class="language-plaintext highlighter-rouge">ngx_hash_init_t</code><strong>å®ä¾‹åŒ–</strong>(ç±»ä¼¼äºOOPæ€æƒ³ï¼Œå’Œå†…æ ¸é©±åŠ¨çš„ç”¨æ³•ç›¸åŒ)ä¸€ä¸ª<code class="language-plaintext highlighter-rouge">hash_init</code>ã€‚</p>

<p>ç„¶åå¯¹è¿™ä¸ªâ€œå¯¹è±¡â€èµ‹å€¼ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hash = (ngx_hash_t*)ngx_pcalloc(pool, sizeof(hash));
hash_init.hash = hash;            // hashç»“æ„
hash_init.key = &amp;ngx_hash_key_lc; // hashç®—æ³•å‡½æ•°
hash_init.max_size = 1024*10;     // max_size
hash_init.bucket_size = 64;       //æ¡¶çš„å¤§å°
hash_init.name = "yahoo_guy_hash"; 
hash_init.pool = pool;            // ç”¨åˆ°çš„å†…å­˜æ± 
hash_init.temp_pool = NULL;
</code></pre></div></div>
<p>ç¬¬ä¸€è¡Œåˆ†é…äº†<code class="language-plaintext highlighter-rouge">ngx_hash_t</code>å¤§å°çš„å†…å­˜å­˜å‚¨å¦‚ä¸‹hashç»“æ„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct {
    ngx_hash_elt_t  **buckets;
    ngx_uint_t        size;
} ngx_hash_t;
</code></pre></div></div>

<p>ç„¶ååˆ›å»ºä¸€ä¸ªéœ€è¦åŠ åˆ°hash tableä¸­çš„æ•°ç»„ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ngx_hash_key_t* arr_node; //å­˜å‚¨é”®å€¼å¯¹+hashå€¼
elements = ngx_array_create(pool, 32, sizeof(ngx_hash_key_t));
for(i = 0; i &lt; 3; i++) {
    arr_node = (ngx_hash_key_t*) ngx_array_push(elements);
    arr_node-&gt;key = (names[i]);
    arr_node-&gt;key_hash = ngx_hash_key_lc(arr_node-&gt;key.data, \
    arr_node-&gt;key.len);
    arr_node-&gt;value = (void*)descs[i];
}

ngx_hash_init(&amp;hash_init, (ngx_hash_key_t*) elements-&gt;elts, \
elements-&gt;nelts)
</code></pre></div></div>

<p>æœ€åå°†<code class="language-plaintext highlighter-rouge">elements</code>æ•°ç»„æ”¾åˆ°<code class="language-plaintext highlighter-rouge">hash_init</code>ç»“æ„ä¸­ï¼Œå³å°†æ•°ç»„ä»¥hash tableå½¢å¼å­˜å‚¨ã€‚</p>

<p>è¿™å°±æ˜¯æ•´ä¸ªhashç»“æ„çš„å­˜å‚¨è¿‡ç¨‹ï¼ŒæŸ¥æ‰¾ç›¸å¯¹ç®€å•ï¼Œè¿™é‡Œä¸å†è¯¦è¿°ã€‚</p>

<hr />

<p>##å‚è€ƒ
Linux Kernel Development. Page71~72</p>

<p><a href="http://www.embedu.org/Column/Column433.htm">http://www.embedu.org/Column/Column433.htm</a></p>

:ET