I"1<p>ä¸€ä¸ªå®Œæ•´çš„ Web åº”ç”¨åŒ…å«å‰ç«¯é¡µé¢ã€æ•°æ®åº“ã€åå°é€»è¾‘ç­‰ï¼ŒæŒ‰ç…§ä¸€èˆ¬æµç¨‹å»æ„å»ºéœ€è¦é…ç½® Nginxã€MySQLï¼Œä»¥åŠåå°æœåŠ¡å™¨ï¼Œè¿ç»´æ¶‰åŠåˆ°çš„éƒ¨åˆ†ååˆ†å¤æ‚ã€‚è€Œ Docker å¯ä»¥å°†è¿™äº›ä¸œè¥¿ï¼ˆæ•°æ®+æœåŠ¡ï¼‰å°è£…èµ·æ¥ï¼Œè™½ç„¶æœ‰äº›åœºåˆä¸å»ºè®®æ•°æ®å’ŒæœåŠ¡æ”¾åœ¨ä¸€èµ·ã€‚æœ¬æ–‡å°±åœ¨ä¸€ä¸ª Docker å®¹å™¨ä¸­å®Œæ•´éƒ¨ç½²æ•´ä¸ª Web åº”ç”¨çš„éœ€æ±‚ä½œè¯¦ç»†çš„ä»‹ç»ã€‚</p>

<p>æœ¬æ–‡ä¸¾ä¾‹çš„ Web åº”ç”¨ä¸º ã€Œtop-topic-Zhihuã€(æ¢ä¸ª timeline çœ‹çŸ¥ä¹)ï¼Œæ•´ä¸ªé¡¹ç›®å¯ä»¥åœ¨ <a href="https://github.com/Huangtuzhi/top-topic-Zhihu">Github</a> ä¸­æ‰¾åˆ°ã€‚</p>

<p>Dockerfile å’Œä¾èµ–æ–‡ä»¶æ‰˜ç®¡åœ¨ <a href="https://github.com/Huangtuzhi/docker-toptopic">docker-toptopic</a>ï¼Œäº‘æœåŠ¡å•†é€‰æ‹©ã€Œ<a href="https://hub.alauda.cn/repos/huangtuzhi/docker-toptopic">çµé›€äº‘</a>ã€æä¾›å®¹å™¨æœåŠ¡ã€‚</p>

<p>åœ¨ã€Œçµé›€äº‘ã€æœåŠ¡æä¾›çš„åŸŸå <a href="http://toptopic-huangtuzhi.myalauda.cn:19991/">http://toptopic-huangtuzhi.myalauda.cn:19991/</a> å¯ä»¥çœ‹åˆ°æœ¬ç½‘ç«™ï¼ˆå¦‚æœæ˜¾ç¤ºä¸æ­£å¸¸ï¼Œæ˜¯å› ä¸ºæ²¡ä½™é¢äº†ã€‚å¯ä»¥åœ¨æœ¬åœ°è¿›è¡Œæ­å»ºæµ‹è¯•ï¼‰ã€‚</p>

<hr />

<h2 id="æ–‡ä»¶ç›®å½•">æ–‡ä»¶ç›®å½•</h2>

<p>æ•´ä¸ª Web åº”ç”¨çš„ç›®å½•ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>â”œâ”€â”€ docker-toptopic
â”‚Â Â  â”œâ”€â”€ Dockerfile      
â”‚Â Â  â”œâ”€â”€ init.sh        # å¯åŠ¨ Nginx MySQL å’Œåå° Server çš„åˆå§‹åŒ–è„šæœ¬
â”‚Â Â  â”œâ”€â”€ mysql          # MySQL é…ç½®æ–‡ä»¶
â”‚Â Â  â”‚Â Â  â””â”€â”€ my.cnf    
â”‚Â Â  â”œâ”€â”€ nginx          # Nginx é…ç½®æ–‡ä»¶
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ global.conf
â”‚Â Â  â”‚Â Â  â””â”€â”€ nginx.conf
â”‚Â Â  â”œâ”€â”€ question.txt   # éœ€è¦å¯¼å…¥åˆ° DB çš„æ•°æ®
â”‚Â Â  â”œâ”€â”€ README.md
â”‚Â Â  â””â”€â”€ web
â”‚Â Â      â”œâ”€â”€ dataAccess.py # åå° Server çš„ AO æœåŠ¡
â”‚Â Â      â”œâ”€â”€ dataCGI.py    # åå° Server
â”‚Â Â      â””â”€â”€ www           # ç½‘ç«™
â”‚Â Â          â”œâ”€â”€ assets
â”‚Â Â          â”‚Â Â  â”œâ”€â”€ tuzhii.ico
â”‚Â Â          â”‚Â Â  â””â”€â”€ tuzhii.jpg
â”‚Â Â          â”œâ”€â”€ css
â”‚Â Â          â”‚Â Â  â”œâ”€â”€ button.css
â”‚Â Â          â”‚Â Â  â””â”€â”€ toptopic.css
â”‚Â Â          â”œâ”€â”€ index.html
â”‚Â Â          â””â”€â”€ js
â”‚Â Â              â””â”€â”€ template.js
</code></pre></div></div>

<hr />

<h2 id="dockerfile">Dockerfile</h2>

<p>Dockerfile æè¿°äº†å®¹å™¨çš„ä¾èµ–å’Œè¿›è¡Œæ„å»ºçš„æ­¥éª¤ï¼Œä¸‹é¢ä¼šé€æ­¥è§£é‡Šè¯­å¥çš„å«ä¹‰ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu
MAINTAINER titushuang "ituzhi@163.com"
ENV REFRESHED_AT 2015-10-12

RUN apt-get update \
    &amp;&amp; apt-get install -y mysql-server-5.6 python  python-dev python-pip libmysqlclient-dev nginx

RUN pip install MySQL-python flask 
RUN pip install -U flask-cors

RUN mkdir -p /home/toptopic /home/toptopic/web

COPY init.sh /home/toptopic/init.sh
COPY web /home/toptopic/web
COPY question.txt /home/toptopic/question.txt

COPY nginx/global.conf /etc/nginx/conf.d/
COPY nginx/nginx.conf /etc/nginx/nginx.conf
COPY mysql/my.cnf /etc/mysql/my.cnf

RUN ln -s /home/toptopic/web/www /usr/share/nginx/html

RUN chmod +x /home/toptopic/init.sh 
RUN chmod -R 755 /home/toptopic/web

RUN ./etc/init.d/mysql start &amp;&amp;\  
    mysql -e "grant all privileges on *.* to 'root'@'%' identified by 'dbpasswd';"&amp;&amp;\  
    mysql -e "grant all privileges on *.* to 'root'@'127.0.0.1' identified by 'dbpasswd';"&amp;&amp;\  
    mysql -e "CREATE DATABASE top_topic_zhihu; use top_topic_zhihu;"&amp;&amp;\ 
    mysql -e "CREATE TABLE top_topic_zhihu.question(question_id varchar(30) NOT NULL, \
    title varchar(200), ask_time datetime,followers int)"&amp;&amp;\ 
    mysql -e "load data infile '/home/toptopic/question.txt' into \
    table top_topic_zhihu.question fields terminated by ';;'"&amp;&amp;\ 
    mysql -e "grant all privileges on *.* to 'root'@'localhost'\
     identified by 'dbpasswd';"

EXPOSE 2223 5000

CMD ["/home/toptopic/init.sh"]
</code></pre></div></div>

<hr />

<h2 id="mysql-å®‰è£…å’Œé…ç½®">MySQL å®‰è£…å’Œé…ç½®</h2>

<p>MySQL æœåŠ¡å™¨åªéœ€è¦ç”¨åŒ…ç®¡ç†å™¨å®‰è£… mysql-server-5.6ï¼Œå› ä¸ºåå°ä½¿ç”¨ Python ä½œä¸ºæœåŠ¡å™¨è¯­è¨€ï¼Œè¿˜éœ€è¦å®‰è£… MySQL å¯¹ Python è¯­è¨€çš„æ”¯æŒã€‚éœ€è¦ä½¿ç”¨ apt å®‰è£… python ï¼Œlibmysqlclient-dev å’Œ python-devï¼Œç„¶åä½¿ç”¨ pip ç®¡ç†å™¨å®‰è£… MySQL-pythonã€‚</p>

<p>MySQL çš„é»˜è®¤å­—ç¬¦é›†ä¸º latin1ï¼Œè€Œç½‘é¡µæ˜¾ç¤ºä¸€èˆ¬æ˜¯ utf8 å­—ç¬¦é›†ï¼Œéœ€è¦å°† MySQL çš„é…ç½®æ–‡ä»¶çš„å­—ç¬¦é›†ç½®ä¸º utf8ã€‚</p>

<p>ä½¿ç”¨å‘½ä»¤</p>

<p><code class="language-plaintext highlighter-rouge">COPY mysql/my.cnf /etc/mysql/my.cnf</code></p>

<p>å°†æœ¬åœ°å·²ä¿®æ”¹å¥½çš„é…ç½®æ–‡ä»¶è¦†ç›– Docker ä¸­çš„ MySQL é…ç½®æ–‡ä»¶ã€‚æŸ¥çœ‹å­—ç¬¦é›†</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mysql&gt; SHOW VARIABLES LIKE 'character_set_%'; 
+--------------------------+----------------------------+
| Variable_name            | Value                      |
+--------------------------+----------------------------+
| character_set_client     | utf8                       |
| character_set_connection | utf8                       |
| character_set_database   | utf8                       |
| character_set_filesystem | binary                     |
| character_set_results    | utf8                       |
| character_set_server     | utf8                       |
| character_set_system     | utf8                       |
| character_sets_dir       | /usr/share/mysql/charsets/ |
+--------------------------+----------------------------+
8 rows in set (0.00 sec)
</code></pre></div></div>

<p>è‹¥å­—ç¬¦é›†å¦‚ä¸Šæ‰€ç¤ºï¼Œåˆ™è¯´æ˜å·²ç»ä¿®æ”¹æˆåŠŸã€‚</p>

<h3 id="mysqlçš„å‘">MySQLçš„å‘</h3>

<p>åœ¨ä¸Šé¢çš„ Dockerfile ä¸­çœ‹åˆ°åˆ†åˆ«ç»™ â€˜rootâ€™@â€™127.0.0.1â€™ å’Œ â€˜rootâ€™@â€™localhostâ€™ éƒ½åŠ äº†æƒé™ï¼Œ â€˜rootâ€™@â€™localhostâ€™ çš„æƒé™åœ¨ SQL è¯­å¥æœ€åæ‰åŠ ä¸Šã€‚è¿™æ˜¯å› ä¸º</p>

<ul>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">'root'@'localhost'</code> æ²¡æƒé™å»ºæ•°æ®åº“å’Œè¡¨ï¼ŒæŠ¥é”™</li>
</ul>

<blockquote>
  <p>Access denied for user â€˜rootâ€™@â€™localhostâ€™ (using password: No)</p>
</blockquote>

<ul>
  <li>ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">'root'@'127.0.0.1'</code> è¿›å…¥ Docker åæ²¡æƒé™è¿æ¥ Mysqlï¼ŒæŠ¥é”™</li>
</ul>

<blockquote>
  <p>Access denied for user â€˜rootâ€™@â€™localhostâ€™ (using password: YES)</p>
</blockquote>

<p>äºæ˜¯è¿™é‡Œç”¨ <code class="language-plaintext highlighter-rouge">'root'@'127.0.0.1'</code> æ¥å»ºæ•°æ®åº“å’Œè¡¨ï¼Œæœ€åå†ç”¨ <code class="language-plaintext highlighter-rouge">'root'@'localhost'</code> æ¥è¿æ¥æ•°æ®åº“ã€‚</p>

<hr />

<h2 id="nginx-å®‰è£…å’Œé…ç½®">Nginx å®‰è£…å’Œé…ç½®</h2>

<p>Nginx åœ¨è¿™é‡Œä½œä¸ºé™æ€é¡µé¢çš„æœåŠ¡å™¨ï¼Œå®‰è£…åªéœ€è¦ç”¨ apt ç®¡ç†å™¨å®‰è£…å³å¯ã€‚</p>

<p>Nginx éœ€è¦é…ç½® root ç›®å½•æ¥æŒ‡å®šç½‘ç«™çš„æ–‡ä»¶ä½ç½®ï¼ŒæŠŠæœ¬åœ°çš„ global.conf å’Œ nginx.conf æ–‡ä»¶è¦†ç›–åˆ° Docker ä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>COPY nginx/global.conf /etc/nginx/conf.d/
COPY nginx/nginx.conf /etc/nginx/nginx.conf
</code></pre></div></div>

<p>åœ¨ global.conf ä¸­æˆ‘ä»¬æŒ‡æ˜æœåŠ¡å™¨æ ¹ç›®å½•ä¸º <code class="language-plaintext highlighter-rouge">/usr/share/nginx/html/www</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
        listen          0.0.0.0:2223;
        server_name     _;

        root            /usr/share/nginx/html/www;
        index           index.html index.htm;
        }
</code></pre></div></div>

<p>åœ¨ Docker ä¸­ï¼Œæˆ‘ä»¬å°†ç½‘ç«™æ–‡ä»¶æ”¾åˆ°æ–°å»ºçš„ <code class="language-plaintext highlighter-rouge">/home/toptopic/web/www</code>ç›®å½•ã€‚è¿™é‡Œå»ºç«‹ä¸€ä¸ªè½¯é“¾æ¥å°†å®ƒä»¬å…³è”èµ·æ¥ï¼Œä¾¿äºä¿®æ”¹å’Œç»´æŠ¤ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RUN ln -s /home/toptopic/web/www /usr/share/nginx/html
</code></pre></div></div>

<hr />

<h2 id="expose-ä¸¤ä¸ªç«¯å£">EXPOSE ä¸¤ä¸ªç«¯å£</h2>

<p>EXPOSE åœ¨ Docker ä¸­ç”¨æ¥é™åˆ¶å¼€æ”¾çš„ç«¯å£ã€‚æˆ‘ä»¬ä½¿ç”¨ Nginx æ¥æä¾›é™æ€é¡µé¢è®¿é—®ï¼Œä½¿ç”¨ Flask æ¡†æ¶æ¥æä¾›åŠ¨æ€é¡µé¢æ•°æ®çš„è·å–ï¼Œæ‰€ä»¥éœ€è¦å¼€æ”¾ä¸¤ä¸ªç«¯å£ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXPOSE 2223 5000
</code></pre></div></div>

<p>æŸ¥è¯¢ç«¯å£çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ°å®¿ä¸»æœº 2333 ç«¯å£è¢«æ˜ å°„åˆ° Docker çš„ 2333 ç«¯å£ï¼Œå®¿ä¸»æœº 5000 ç«¯å£è¢«æ˜ å°„åˆ° Docker çš„ 5000 ç«¯å£ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hy@HP /tmp $ sudo docker ps
[sudo] password for huangyi: 
CONTAINER ID      IMAGE                COMMAND         
CREATED           STATUS               PORTS         NAMES
2d1d03d08a95        titus/mysql:latest   /bin/bash   
9 seconds ago      Up 9 seconds   0.0.0.0:2223-&gt;2223/tcp,0.0.0.0:5000-&gt;5000/tcp   clever_hoover
</code></pre></div></div>

<p>2223 ç«¯å£ä¸ä¸ŠèŠ‚ä¸­çš„ Nginx ä¸­è®¾å®šçš„ç«¯å£å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå› ä¸º Nginx ä½¿ç”¨ 2223 ç«¯å£æä¾›æœåŠ¡ï¼ŒDocker åˆšå¥½å¿…é¡»æŠŠè¿™ä¸ªç«¯å£å¼€æ”¾å‡ºå»ã€‚</p>

<p>åœ¨åŸºäº Flask æ¡†æ¶å†™çš„åå°æœåŠ¡ dataCGI.py ä¸­ï¼ŒæœåŠ¡å™¨å¯¹åº”çš„ç›‘å¬åœ°å€ä¸º</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>app.run(host='0.0.0.0', port=5000, debug=True, threaded=True)
</code></pre></div></div>

<p>host å¿…é¡»è®¾ç½®ä¸º 0.0.0.0ï¼Œè¡¨ç¤ºç›‘å¬æ‰€æœ‰çš„ IP åœ°å€ã€‚å¦‚æœ host ä½¿ç”¨ 127.0.0.1ï¼Œåœ¨å®¹å™¨å¤–å°†æ— æ³•è®¿é—®æœåŠ¡ã€‚åŒæ—¶ï¼Œè¿™é‡Œçš„ç«¯å£ 5000 å’Œ Dockerfile ä¸­å¼€æ”¾çš„å¦ä¸€ä¸ªç«¯å£ä¸€è‡´ã€‚</p>

<hr />

<h2 id="å¯åŠ¨è„šæœ¬">å¯åŠ¨è„šæœ¬</h2>

<p>åœ¨ Dockerfile ä¸­çš„ CMD ä¸­å¯ä»¥æŒ‡å®š Docker è¿è¡Œæ—¶æ‰§è¡Œä¸€äº›å‘½ä»¤ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/etc/init.d/mysql start
/etc/init.d/nginx start &amp;
/home/toptopic/web/dataCGI.py
</code></pre></div></div>

<p>è¿™ä¸‰è¡Œåˆ†åˆ«å¯åŠ¨ MySQLï¼ŒNginx å’Œåå°æœåŠ¡ã€‚</p>

<hr />

<h2 id="æ„å»ºå‘½ä»¤">æ„å»ºå‘½ä»¤</h2>

<p>æ„å»º Docker å®¹å™¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker build -t="titus/toptopic" .
</code></pre></div></div>

<p>è¿è¡Œå®¹å™¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run -t -i -p 2223:2223 -p 5000:5000 titus/toptopic
</code></pre></div></div>

<p>éœ€è¦æ³¨æ„çš„æ˜¯è‹¥ä½¿ç”¨</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo docker run -t -i -p 2223:2223 -p 5000:5000 titus/toptopic /bin/bash
</code></pre></div></div>
<p>æ— æ³•å¯åŠ¨ CMD ä¸­çš„è„šæœ¬å‘½ä»¤ï¼Œè¿™æ˜¯å› ä¸ºåœ¨ docker run åæŒ‡å®šäº† /bin/bash åä¼šè¦†ç›– CMD ä¸­çš„å‘½ä»¤ã€‚</p>

<hr />

<h2 id="åœ¨äº‘å¹³å°ä¸Šéƒ¨ç½²">åœ¨äº‘å¹³å°ä¸Šéƒ¨ç½²</h2>

<p>åœ¨ã€Œçµé›€äº‘ã€ä¸Šéƒ¨ç½²ä¸€ä¸ª Docker åº”ç”¨éœ€è¦ä¸¤æ­¥ï¼šæ„å»ºâ€”â€”åˆ›å»ºæœåŠ¡ã€‚</p>

<p><img src="/assets/images/docker-alauda-1.png" alt="å›¾ç‰‡" /></p>

<p>ç‚¹å‡»ã€Œæ„å»ºã€â€”â€”ã€Œåˆ›å»ºé•œåƒæ„å»ºä»“åº“ã€ï¼Œç„¶åé€‰æ‹© Github ä»“åº“æºã€‚éœ€è¦æŠŠé¢„å…ˆå†™å¥½çš„ Dockerfile æ”¾åœ¨ Githubä¸­ã€‚</p>

<p><img src="/assets/images/docker-alauda-2.png" alt="å›¾ç‰‡" /></p>

<p>æ„å»ºå¥½ä»“åº“ä¹‹åï¼Œç‚¹å‡»ã€Œåˆ›å»ºæœåŠ¡ã€ã€‚</p>

<p><img src="/assets/images/docker-alauda-3.png" alt="å›¾ç‰‡" /></p>

<p>è¿›è¡ŒæœåŠ¡çš„è®¾ç½®ï¼Œé«˜çº§è®¾ç½®ä¸­æœåŠ¡åœ°å€ç±»å‹é€‰ä¸º tcp-endpoint å³å¯(å¤–éƒ¨ç”¨æˆ·å¯ä»¥ç›´æ¥é€šè¿‡ TCP æ–¹å¼è®¿é—®è¿™ä¸ªæœåŠ¡åœ°å€ï¼ŒæœåŠ¡åœ°å€çš„ç«¯å£æ˜¯éšæœºåˆ†é…çš„ï¼Œä¸€èˆ¬ä¼šå¤§äº 10000 å°äº 65535)</p>

<p>æœ€åç‚¹å‡»æœ€ä¸‹æ–¹çš„ã€Œåˆ›å»ºæœåŠ¡ã€å®Œæˆéƒ¨ç½²ã€‚æ–°å»ºçš„æœåŠ¡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>

<p><img src="/assets/images/docker-alauda-4.png" alt="å›¾ç‰‡" /></p>

<p>åœ¨æµè§ˆå™¨ä¸­è¾“å…¥<a href="http://toptopic-huangtuzhi.myalauda.cn:19991/">http://toptopic-huangtuzhi.myalauda.cn:19991/</a> å³å¯è®¿é—®ç½‘ç«™ã€‚</p>

<hr />

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p><a href="https://github.com/Huangtuzhi/DockerTutorial">https://github.com/Huangtuzhi/DockerTutorial</a></p>

<p><a href="https://github.com/Huangtuzhi/top-topic-Zhihu">https://github.com/Huangtuzhi/top-topic-Zhihu</a></p>
:ET