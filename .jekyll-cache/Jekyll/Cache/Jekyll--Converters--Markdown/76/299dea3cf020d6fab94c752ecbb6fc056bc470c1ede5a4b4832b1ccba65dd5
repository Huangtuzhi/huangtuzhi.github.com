I"…<p>Nginxå®é™…ä¸Šåªèƒ½å¤„ç†é™æ€èµ„æºè¯·æ±‚ï¼Œé‚£ä¹ˆå¯¹äºåŠ¨æ€è¯·æ±‚æ€ä¹ˆåšå‘¢ã€‚è¿™å°±éœ€è¦ç”¨åˆ°Nginxçš„<code class="language-plaintext highlighter-rouge">upstream</code>æ¨¡å—å¯¹è¿™äº›è¯·æ±‚è¿›è¡Œè½¬å‘ï¼Œå³<strong>åå‘ä»£ç†</strong>ã€‚è¿™äº›æ¥æ”¶è½¬å‘çš„æœåŠ¡å™¨å¯ä»¥æ˜¯Apacheã€Tomcatã€IISç­‰ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>

<p><img src="/assets/images/proxy-1.png" alt="" /></p>

<p>ç°åœ¨å¯¹ä¸€ä¸ªPython Flaskçš„ç«™ç‚¹è¿›è¡Œåå‘ä»£ç†è®¾ç½®ï¼Œç«™ç‚¹çš„æºç å­˜æ”¾åœ¨<a href="https://github.com/Huangtuzhi/GoLink">Github</a>ã€‚åœ¨æœ¬æœºMin17ä¸­ç›®å½•å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/
+- srv/
  +- www/
    +- GoLink/       &lt;-- Web Appæ ¹ç›®å½•
      +- www/        
      |  +- static/  &lt;-- å­˜æ”¾é™æ€èµ„æºæ–‡ä»¶
      |  +- index.py &lt;-- Pythonæºç 
</code></pre></div></div>

<hr />

<h2 id="éƒ¨ç½²æ–¹å¼">éƒ¨ç½²æ–¹å¼</h2>

<p>ç”±äºflaskæ˜¯å•è¿›ç¨‹å¤„ç†è¯·æ±‚çš„ï¼Œä¸åƒTornadoçš„å¼‚æ­¥ï¼ŒåŒæ—¶è®¿é—®çš„äººæ•°ç¨å¾®è¿‡å¤šï¼Œå°±ä¼šå‡ºç°é˜»å¡çš„æƒ…å†µï¼Œå¯¼è‡´Nginxå‡ºç°502çš„é—®é¢˜ã€‚è€ŒGunicornå¯ä»¥æŒ‡å®šå¤šä¸ªå·¥ä½œè¿›ç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°å¹¶å‘åŠŸèƒ½ã€‚</p>

<p><img src="/assets/images/proxy-2.png" alt="" /></p>

<p>Nginxå¯ä»¥ä½œä¸ºæœåŠ¡è¿›ç¨‹ç›´æ¥å¯åŠ¨ï¼Œä½†Gunicornè¿˜ä¸è¡Œã€‚å¯ä»¥ä½¿ç”¨Supervisorç®¡ç†Gunicornè¿›è¡Œè‡ªå¯åŠ¨ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹æˆ‘ä»¬éœ€è¦ç”¨åˆ°çš„æœåŠ¡æœ‰ï¼š</p>

<p>Nginxï¼šé«˜æ€§èƒ½WebæœåŠ¡å™¨+è´Ÿè´£åå‘ä»£ç†ï¼›</p>

<p>gunicornï¼šé«˜æ€§èƒ½WSGIæœåŠ¡å™¨ï¼›</p>

<p>geventï¼šæŠŠPythonåŒæ­¥ä»£ç å˜æˆå¼‚æ­¥åç¨‹çš„åº“ï¼›</p>

<p>Supervisorï¼šç›‘æ§æœåŠ¡è¿›ç¨‹çš„å·¥å…·ï¼›</p>

<p>åœ¨LinuxæœåŠ¡å™¨ä¸Šå¯ä»¥ç›´æ¥å®‰è£…ä¸Šè¿°æœåŠ¡ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get install nginx gunicorn python-gevent supervisor
</code></pre></div></div>

<hr />

<h2 id="é…ç½®nginx">é…ç½®Nginx</h2>
<p>Nginxé…ç½®æ–‡ä»¶ä½äº<code class="language-plaintext highlighter-rouge">/usr/local/nginx/conf/nginx.conf</code>ï¼Œä¸ºäº†ä¾¿äºç®¡ç†ï¼Œæ–°å»ºä¸€ä¸ª<code class="language-plaintext highlighter-rouge">site</code>æ–‡ä»¶å¤¹å­˜æ”¾æˆ‘ä»¬å¯¹é…ç½®çš„æ·»åŠ æ›´æ”¹ã€‚åœ¨<code class="language-plaintext highlighter-rouge">site</code>ä¸­æ–°å»º<code class="language-plaintext highlighter-rouge">app.conf</code>é…ç½®æ–‡ä»¶ã€‚</p>

<p>åœ¨<code class="language-plaintext highlighter-rouge">nginx.conf</code>ä¸­æ·»åŠ </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>http {
    include       sites/*.conf;
    # ...
}
</code></pre></div></div>

<p>åœ¨<code class="language-plaintext highlighter-rouge">app.conf</code>ä¸­æ·»åŠ </p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server {
    listen      80; # ç›‘å¬80ç«¯å£

    root        /srv/www/GoLink/www; 
    server_name localhost; # é…ç½®åŸŸå

    # å¤„ç†é™æ€èµ„æº:
    location ~ ^\/static\/.*$ {
        root /srv/www/GoLink/www;
    }

    # åŠ¨æ€è¯·æ±‚è½¬å‘åˆ°8000ç«¯å£(gunicorn):
    location / {
        proxy_pass       http://127.0.0.1:8000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
</code></pre></div></div>

<p>é‡æ–°åŠ è½½Nginxé…ç½®æ–‡ä»¶ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo .nginx -s reload
</code></pre></div></div>

<hr />

<p>##é…ç½®Supervisor</p>

<p>ç¼–å†™ä¸€ä¸ªSupervisorçš„é…ç½®æ–‡ä»¶<code class="language-plaintext highlighter-rouge">golink.conf</code>ï¼Œå­˜æ”¾åˆ°<code class="language-plaintext highlighter-rouge">/etc/supervisor/conf.d/ç›®å½•ä¸‹</code>ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[program:golink]
command     = /usr/bin/gunicorn --bind 127.0.0.1:8000 
--workers 3 --worker-class gevent index:app
directory   = /srv/www/GoLink/www
user        = www-data
startsecs   = 3

redirect_stderr         = true
stdout_logfile_maxbytes = 50MB
stdout_logfile_backups  = 10
</code></pre></div></div>
<p>å‚æ•°è§£é‡Š</p>

<blockquote>
  <p>â€“workers: The number of worker processes for handling requests. A positive integer generally in the 2-4 x $(NUM_CORES) range.</p>
</blockquote>

<blockquote>
  <p>â€“worker-class: The type of workers to use.</p>
</blockquote>

<p>å¯åŠ¨åå°æœåŠ¡</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo supervisorctl reload
$ sudo supervisorctl start golink
$ sudo supervisorctl status
golink    RUNNING    pid 13636, uptime 0:00:27
</code></pre></div></div>

<p>è¿™æ—¶åœ¨æµè§ˆå™¨ä¸­è¾“å…¥ <code class="language-plaintext highlighter-rouge">http://127.0.0.1ï¼š80</code>å³å¯è®¿é—®ç½‘ç«™ã€‚</p>

<p>è¿˜æœ‰ï¼Œåˆä¸€å¹´è¿‡å»äº†ã€‚çºªå¿µã€‚</p>

<blockquote>
  <p>æ¯•ç«Ÿè¥¿æ¹–å…­æœˆä¸­ï¼Œé£å…‰ä¸ä¸å››æ—¶åŒã€‚</p>
</blockquote>

<hr />

<h2 id="å‚è€ƒ">å‚è€ƒ</h2>

<p><a href="http://rfyiamcool.blog.51cto.com/1030776/1276364">http://rfyiamcool.blog.51cto.com/1030776/1276364</a></p>

<p><a href="http://spacewander.github.io/explore-flask-zh/14-deployment.html">http://spacewander.github.io/explore-flask-zh/14-deployment.html</a></p>

<p><a href="http://docs.gunicorn.org/en/latest/settings.html#settings">http://docs.gunicorn.org/en/latest/settings.html#settings</a></p>
:ET